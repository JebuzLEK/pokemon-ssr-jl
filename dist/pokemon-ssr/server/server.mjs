import './polyfills.server.mjs';
import{b as h,c as g,d as w,g as y}from"./chunk-P2QFSEPP.mjs";import"./chunk-BF7RFS5Q.mjs";import"./chunk-GWUOYYUE.mjs";import{a as l,g as s}from"./chunk-X2SEQXRR.mjs";import*as c from"fs";import{dirname as R,join as C,normalize as S,resolve as E}from"path";import{URL as b,fileURLToPath as I}from"url";import{readFile as A}from"fs/promises";var f=class{resourceCache=new Map;process(e,r){return s(this,null,function*(){return new y(t=>s(this,null,function*(){let a=this.resourceCache.get(t);return a===void 0&&(a=yield A(t,"utf-8"),this.resourceCache.set(t,a)),a}),r).process(e)})}},d="\u{1F170}\uFE0F";function v(){let o=0,e=[];for(let{name:r,duration:n}of performance.getEntriesByType("measure")){if(!r.startsWith(d))continue;let t=r.slice(d.length+1)+":";t.length>o&&(o=t.length),e.push([t,`${n.toFixed(1)}ms`]),performance.clearMeasures(r)}console.log("********** Performance results **********");for(let[r,n]of e){let t=o-r.length+5;console.log(r+" ".repeat(t)+n)}console.log("*****************************************")}function F(o,e){return s(this,null,function*(){let r=`${d}:${o}`,n=`start:${r}`,t=`end:${r}`;try{return performance.mark(n),yield e()}finally{performance.mark(t),performance.measure(r,n,t),performance.clearMarks(n),performance.clearMarks(t)}})}function _(o,e){return e()}var M=/ng-server-context=["']\w*\|?ssg\|?\w*["']/,u=class{options;templateCache=new Map;inlineCriticalCssProcessor=new f;pageIsSSG=new Map;constructor(e){this.options=e}render(e){return s(this,null,function*(){let r=this.options?.enablePerformanceProfiler,n=r?F:_,t=yield n("Retrieve SSG Page",()=>this.retrieveSSGPage(e));return t===void 0&&(t=yield n("Render Page",()=>this.renderApplication(e)),e.inlineCriticalCss!==!1&&(t=yield n("Inline Critical CSS",()=>this.inlineCriticalCss(t,e)))),r&&v(),t})}inlineCriticalCss(e,r){let n=r.publicPath??(r.documentFilePath?R(r.documentFilePath):"");return this.inlineCriticalCssProcessor.process(e,n)}retrieveSSGPage(e){return s(this,null,function*(){let{publicPath:r,documentFilePath:n,url:t}=e;if(!r||!n||t===void 0)return;let{pathname:a}=new b(t,"resolve://"),i=C(r,a,"index.html");if(this.pageIsSSG.get(i))return c.promises.readFile(i,"utf-8");if(!i.startsWith(S(r)))return;if(i===E(n)||!(yield x(i))){this.pageIsSSG.set(i,!1);return}let p=yield c.promises.readFile(i,"utf-8"),m=M.test(p);return this.pageIsSSG.set(i,m),m?p:void 0})}renderApplication(e){return s(this,null,function*(){let r=this.options?.bootstrap??e.bootstrap;if(!r)throw new Error("A module or bootstrap option must be provided.");let n=[{provide:h,useValue:"ssr"},...e.providers??[],...this.options?.providers??[]],t=e.document;!t&&e.documentFilePath&&(t=yield this.getDocument(e.documentFilePath));let a={url:e.url,document:t};return G(r)?w(r,l({platformProviders:n},a)):g(r,l({extraProviders:n},a))})}getDocument(e){return s(this,null,function*(){let r=this.templateCache.get(e);return r||(r=yield c.promises.readFile(e,"utf-8"),this.templateCache.set(e,r)),r})}};function x(o){return s(this,null,function*(){try{return yield c.promises.access(o,c.constants.F_OK),!0}catch{return!1}})}function G(o){return typeof o=="function"&&!("\u0275mod"in o)}var P=o=>s(null,null,function*(){let e=globalThis.CommonEngineArgsFactory.get();return new Response(yield o.render(e),{headers:{"content-type":"text/html"}})});var T=new u;function B(o,e){return s(this,null,function*(){return yield P(T)})}export{B as netlifyCommonEngineHandler};
